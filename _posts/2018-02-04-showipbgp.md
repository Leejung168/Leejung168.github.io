---
layout: post
title: BGP
date: 2018-02-04 
tags: show ip bgp
---

### show ip bgp

```
R1#show ip bgp  | begin Network
   Network          Next Hop            Metric LocPrf Weight Path
*>i192.168.1.196/30 192.168.1.222            0    100      0 i
*>i192.168.1.200/30 192.168.1.205            0    100      0 400 i
*>i192.168.1.204/30 192.168.1.197            0    100      0 i
*> 192.168.1.208/30 0.0.0.0                  0         32768 i
*> 192.168.1.212/30 192.168.1.210            0             0 300 i
*> 192.168.1.216/30 192.168.1.225            0             0 200 i
r>i192.168.1.220/30 192.168.1.222            0    100      0 i
*> 192.168.1.224/30 0.0.0.0                  0         32768 i
*>i192.168.50.0     192.168.1.205            0    100      0 400 i
*>i192.168.75.0     192.168.1.205            0    100      0 400 i
*> 192.168.100.0    192.168.1.225            0             0 200 i
*> 192.168.200.0    192.168.1.225            0             0 200 i
*> 192.168.250.0    192.168.1.210            0             0 300 100    i
```

>\* : 说明对应的路由条目是有效的；
<br>

>\> : 该路径是路由器当前使用的路由，该最佳路径是拥有最短AS_PATH的路径；
<br>

>i : 说明这个条目是从iBGP学习到的；
<br>

>Network : 目标网络，如果没有子网掩码，用默认的A类，B类或C类；
<br>

>Next Hop：顾名思义，达到目标网络的下一条
<br>

>Metric：用于域间路由的优先级，默认为0
<br>

>LocPrf: 即“Local perference”, 用于选择在同一个AS内到达目标路由的优先级，值越大，优先级越高。这个值是从邻居学习过来的，默认值为100；通过bgp default local-preference进行更改，改变的值只在iBGP邻居间进行宣告；该属性仅用于内部对等体之间的Update消息， 而不会被传递给其他自治系统。
<br>

>Weight：从邻居(iBGP或eBGP)学习到的路由条目，这个值将会设置为0，如果对应的路由条目直连在本地的路由器上，这个值将为32768；路由选路的时候，这个属性有最高的优先级，会覆盖其他的属性；这个属性是Cisco的专用BGP参数，仅用于单个路由器内的路由，该数值不与其它路由器进行交换。权值是一种可以分配给路由的数值，权值越高，表示该路由越优。需要注意的是，这种优先级仅在本地对单台路由器生效，权值信息既不会被包括在BGP Update信息种，也不会以任何方式告诉邻居；
<br>

>Path: 如果路由条目从iBGP或存在与本地，那么这个值将为i，如果是从其它的AS学习到的，那么这个值将会为"ASN ASN .... i"，最后的i表示路由终结在IGP。


如果去往目的地有多条路径，Cisco路由器怎么去选路呢？

>Cisco的默认EBGP实现是仅选择一条路径，其它IP路由协议在默认情况下是通过4条等价路径做负载均衡。与其它IP路由协议一样，命令maximum-paths用于更改并行路径的默认最大值，其取值范围是1～6.需要注意的是，负载均衡仅能用于EBGP，IBGP只能使用一条链路；

什么是IBGP，什么是EBGP？
>与BGP发言方对等的邻居既可以在不同AS中， 也可以在同一AS中。 如果邻居位于不同AS中， 则该邻居 为外部对等体（ external peer）， 此时的BGP被称为EBGP（ external BGP， 外部BGP）。 如果 邻居位于同一AS中， 则该邻居为内部对等体（ internal peer）， 此时的BGP被称为 IBGP（ internal BGP， 内部BGP）。

BGP是如何交换路由信息的？
>两个邻居在首次建立BGP对等连接时， 会交换各自的全部BGP路由表，之后则仅交换增量的部分路由更新。 也就是说， 仅当网络出现变动时才相互交换路由信息，并且仅交换变动信息。 由于BGP并不使用周期性的 路由更新机制， 因而对等体之间必须交换保持激活（keepalive）消息， 以维护该对等连接。 Cisco的 默认Keepalive消息间隔是60秒（RFC 1771并没有指定标准的保持激活间隔时间），如果在3个间隔时间 内对等体未收到Keepalive消息， 那么该对等体将宣告其邻居停用（down）。 也可以通过命令timers bgp来修改间隔时间。

BGP的消息类型:
>在建立BGP对等连接之前， 两个邻居必须执行标准的TCP三次握手进程， 并在端口179打开TCP连接。

>Open（打开）信息
<br>
>Keepalive（保持激活）消息
<br>
>Update（更新）消息
<br>
>Notification（通告）消息
<br>


1． Open（打开）消息TCP会话建立之后， 两个邻居都要发送Open消息， 每个邻居都利用该消息标识自己并指定其BGP操作参数。 Open消息包括以下信息。
 
* BGP版本号（BGP version number）： 该字段指定发起方正在运行的BGP版本号（2、3或4）。 除非使用命令neighbour version来强制要求路由器运行早期版本， 否则默认值为BGP- 4。 如果邻居运行的是早期版本的BGP，则该邻居将拒绝指定了版本4的Open消息；此时， BGP-4路由器将更改到BGP-3 并再次发送一条指定该版本号的Open消息。该协商过程将持续到邻居双方 都同意的相同版本时为止。
* 自治系统号（Autonomous system number）： 该字段表示会话发起路由器的AS号，该消息可以确定该BGP会话是EBGP（与邻居的AS号不同）或IBGP（邻居的AS号相同）。
* 保持时间（Hold time）： 该字段表示路由器在收到Keepalive消息或Update消息之前可以等待的最长时间（以秒为单位）。 保持时间必须是0秒（此时必须不发送Keepalive消息）或至少 3秒， Cisco的默认保持时间为180秒。如果邻居双方的保持时间不一致， 那么将以较短的时间作为双方接受的保持时间。 
* BGP标识符（BGP identifier）：该字段标识邻居的IP地址。 Cisco IOS确定BGP标识符的过程与确定OSPF路由器ID的过程完全一致——使用数值最大的环回（loopback）地址； 如果环回 接口没有配置IP地址， 则使用数值最大的物理接口上的IP地址。 
* 可选参数（Optional parameters）：该字段用来宣告支持验证、多协议支持和路由刷新等可选能力。

2．Keepalive（保持激活）消息：如果路由器接受其邻居发送来的Open消息中指定的参数，则响应一条Keepalive消息。 此后， Cisco在默认情况下每60秒发送一条Keepalive消息， 或者以 已协商一致的保持时间的1/3为周期发送Keepalive消息。

3．Update（更新）消息： Update消息用于宣告可行路由、 已撤销路由或两者。 Update消息包括以下信息。 

* NLRI（Network Layer Reachability Information， 网络层可达性信息）： 该字段是一个或多个宣告IP地址前缀及其长度的（长度， 前缀）二元组。 例如， 如果宣告的是206. 193.160.0/19， 那么 其长度部分为/19， 前缀部分为206.193.160。 
* 路径属性（Path Attributes）： 该属性提供了允许BGP选择最短路径、 检测路由环路、 确定路由策略的相关信息。 
*  已撤销路由（Withdrawn Routes）：描述那些已变为不可达且退出服务的目的地的（长度， 前缀）二元组。 请注意，虽然NLRI字段中可能会包含多个前缀， 但是每条Update消息仅描述单 条BGP路由（这是因为路径属性仅描述单条路径，不过该路径可能会通往多个目的地）。

4． Notification（通告）消息：路由器只要检测到差错，就会发送Notification消息并关闭BGP连接。使用Notification消息的一个例子就是在邻居之间协商BGP版本号。 建立了TCP连接 之后， 如果BGP-3发言者接收到一个指定版本号为4的Open消息，则会响应一条申明不支持该版本的Notification消息。



### Next_HOP属性
 * 如果宣告路由器与接收路由器位于不同的自治系统中（外部对等体）， 那么NEXT_HOP是宣告路由器的接口IP地址； 
 * 如果宣告路由器与接收路由器位于同一自治系统中（内部对等体），且Update消息的NLRI指向的是同一 AS内的目的地， 那么NEXT_HOP是宣告该路由的邻居的IP地址； 
 * 如果宣告路由器和接收路由器是内部对等体， 且Update消息的NLRI指向的是不同AS内的目的地，那么 NEXT_HOP是外部对等体（通过该对等体学习到该路由）的IP地址。
