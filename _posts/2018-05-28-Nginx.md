<!-----
layout: post
title: Nginx讲解
date: 2018-05-28
tags: Nginx
----->

## 大纲:
* 什么是Nginx
* 如何安装Nginx(Redhat 6.9)
* Nginx的目录结构，及其主要配置文件讲解
* Nginx如何处理一个request及配置虚拟主机
* Nginx上配置重定向
* 如何排查Application Gateway为502的问题

## 目的：
* 当AppGw的后端为开源的web服务器时，如何排查AppGw的502问题？

## 预备知识:
* **vim**: 高效的linux文本编辑器，类似于windows下的notepad或notepad++. 参考学习文档：[vim 程序编辑器](http://cn.linux.vbird.org/linux_basic/0310vi.php)
* **curl**: 是一个利用URL语法在命令行下工作的文件传输工具, 类似于图形化界面的浏览器，支持上传下载，支持ICT, FILE, FTP, FTPS, GOPHER, HTTP, HTTPS, IMAP, IMAPS, LDAP, LDAPS, POP3, POP3S, RTMP, RTSP, SCP, SFTP, SMB, SMBS, SMTP, SMTPS, TELNET and TFTP等协议。

	```
	# 访问 www.lzzzz.top. -I：只显示HTTP相应头部。
	[root@srv-lambert-centos-test1 ~]# curl -I https://www.lzzzz.top
	HTTP/1.1 200 OK
	Content-Type: text/html; charset=utf-8
	Server: GitHub.com
	Last-Modified: Tue, 14 Nov 2017 10:41:21 GMT
	Access-Control-Allow-Origin: *
	Expires: Wed, 30 May 2018 10:59:51 GMT
	Cache-Control: max-age=600
	X-GitHub-Request-Id: 6394:4F7D:B5D78:102D54:5B0E81CF
	Content-Length: 20861
	Accept-Ranges: bytes
	Date: Wed, 30 May 2018 10:51:00 GMT
	Via: 1.1 varnish
	Age: 69
	Connection: keep-alive
	X-Served-By: cache-sin18029-SIN
	X-Cache: HIT
	X-Cache-Hits: 1
	X-Timer: S1527677461.641680,VS0,VE1
	Vary: Accept-Encoding
	X-Fastly-Request-ID: 8abf90b2e67f678a736e985fd5b6ef1b202a9461
	```

* **cat**: Linux系统中最常用的命令之一，主要用来查看文件的内容，类似于windows下的notepad. 比如:
 
    ```
    # 打印/etc/resolv.conf文件的所有内容
	[root@srv-lambert-centos-test1 ~]# cat /etc/resolv.conf
	; generated by /sbin/dhclient-script
	search e3n5edmlpdcebhrj2vb0sww3yf.ix.internal.cloudapp.net
	nameserver 168.63.129.16
	 ```
 
* **tail**: Linux系统中最常用的命令之一，主要作用是查看文件内容，不同于cat的是，默认情况下tail只显示最后10行的内容，当然tail支持其他的参数，比如:

    ```
    # 实时显示/var/log/access.log文件的内容
	[root@srv-lambert-centos-test1 ~]# tail -f /var/log/access.log 
	10.0.2.5 - - [13/Feb/2018:14:14:24 +0800] "GET / HTTP/1.1" 200 6 "-" "-"
	10.0.2.4 - - [13/Feb/2018:14:14:38 +0800] "GET / HTTP/1.1" 200 6 "-" "-"
	10.0.2.4 - - [13/Feb/2018:14:14:38 +0800] "GET / HTTP/1.1" 200 6 "-" "-"
	10.0.2.4 - - [13/Feb/2018:14:14:39 +0800] "GET / HTTP/1.1" 200 6 "-" "-"
	10.0.2.5 - - [13/Feb/2018:14:14:54 +0800] "GET / HTTP/1.1" 200 6 "-" "-"
	
	```
* **grep**: 用来过滤文件中的内容。类似于windows下的findstr。 比如：

   ```
	# 从网站访问日志过滤包含404的请求
	[root@srv-lambert-centos-test1 ~]# cat /var/log/nginx/access.log | grep 404
	13.66.211.164 - - [28/May/2018:04:26:14 +0800] "GET /flumemaster.jsp HTTP/1.1" 404 3652 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)" "-"
	13.66.211.164 - - [28/May/2018:04:26:14 +0800] "GET /rs-status HTTP/1.1" 404 3652 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)" "-"
	13.66.211.164 - - [28/May/2018:04:26:14 +0800] "GET /nmaplowercheck1527452816 HTTP/1.1" 404 3652 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)" "-"
   ```
 * **yum**: Redhat/CentOS系统软件包管理工具. 常用操作：

   ```
   1. 安装telnet工具
	 [root@srv-lambert-centos-test1 ~]# yum install telnet
   2. 删除telnet工具
	 [root@srv-lambert-centos-test1 ~]# yum remove telnet
	3. 更新telnet工具
     [root@srv-lambert-centos-test1 ~]# yum update telnet
   ```
   
* **apt-get**: Ubuntu系统软件包管理工具. 

   ```
   1. 安装telnet工具
	 [root@srv-lambert-ubuntu-test1 ~]# apt-get install telnet
   2. 删除telnet工具
	 [root@srv-lambert-ubuntu-test1 ~]# apt-get remove telnet
	3. 更新telnet工具
     [root@srv-lambert-ubuntu-test1 ~]# apt-get update telnet
   ``` 
 
## 什么是Nginx
* 是一个异步框架的Web服务器. 该软件由Igor Sysoev(Russian)创建，并于2004年首次公开发布。
* 可以用作反向代理，代理php,python,java等程序。
* 负载平衡器，可以配置成基于四层或七层的负载转发。
* HTTP静态缓存服务器，用于响应用户的静态请求。众所周知的CDN。
* 解决了C10k问题。
* 支持添加[模块](https://www.nginx.com/resources/wiki/modules/)
* 开源软件，根据类BSD许可证的条款发布.
* 截至2018年1月，Nginx 服务或者代理了全球 30.46% 的网站

## 如何安装Nginx：

   > 通过源码编译安装。不做介绍,感兴趣请参考: [Nginx安装方式](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/)
   
   > 通过编译后的软件包安装.

1. 配置官方安装仓库，**注意**：我的系统是基于Redhat 6.9，请通过 "cat /etc/redhat-release" 查看系统版本，然后替换掉baseurl的OS，如果是Redhat，那么值为rhel，如果是CentOS，那么值为centos。 baseurl中的Release是操作系统的主版本。


	```
	[root@srv-lambert-centos-test1 ~]# cat /etc/redhat-release
	Red Hat Enterprise Linux Server release 6.9 (Santiago)
	[root@srv-lambert-centos-test1 ~]# cat << 'EOF' >> /etc/yum.repos.d/nginx.repo
	[nginx]
	name=nginx repo
	#baseurl=https://nginx.org/packages/mainline/<OS>/<Release>/$basearch/
	baseurl=https://nginx.org/packages/mainline/rhel/6/$basearch/
	gpgcheck=0
	enabled=1
	EOF
	 ```
2. 安装Nginx
	
	```
	[root@srv-lambert-centos-test1 ~]# yum install nginx -y
	```
	
3. 启动Nginx服务
  
   ```
   [root@srv-lambert-centos-test1 ~]# /etc/init.d/nginx start
	Starting nginx:                                            [  OK  ]
	```

4. 查看Nginx的进程

	```
	[root@srv-lambert-centos-test1 ~]# netstat -nlpt | grep nginx
	tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      73392/nginx
	[root@srv-lambert-centos-test1 ~]# ps aux | grep nginx
	root      73392  0.0  0.1  47324  1100 ?        Ss   15:48   0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
	nginx     73393  0.0  0.1  47840  1832 ?        S    15:48   0:00 nginx: worker process
	```

## Nginx的目录结构
1. 查看Nginx的目录结构

	```
	[root@srv-lambert-centos-test1 ~]# tree /etc/nginx
	/etc/nginx
	|-- conf.d  # 有经验的工程师会将自己的虚拟主机定义在conf.d中，便于管理
	|   `-- default.conf # 安装好之后有个默认的虚拟主机文件
	|-- fastcgi_params #在做配置fastcgi代理时，会include这个文件，然后nginx会修改对应变量的值，将其和请求一块传递到后端的FastCGI服务器。
	|-- koi-utf
	|-- koi-win
	|-- mime.types   # 将文件名映射为响应的内容类型，这样浏览器都可以根据内容类型去做渲染。
	|-- modules -> ../../usr/lib64/nginx/modules
	|-- nginx.conf   #主配置文件，整个nginx的入口，加载Nginx的主配置文件， 虚拟主机中。
	|-- scgi_params
	|-- uwsgi_params #在配置uwsgi反向代理的时候，会将文件内定义的参数传递给后端的uwsgi服务器。
	`-- win-utf
	
	2 directories, 9 files
	```
2. Nginx的主配置文件, 主要有两部分组成
   > Simple Directive： 其配置参数只有一行。
  
   > Block directives: 由一组参数包括在{}中。

   ```
   [root@srv-lambert-centos-test1 modules]# cat /etc/nginx/nginx.conf

	user  nginx;
	worker_processes  1;
	
	error_log  /var/log/nginx/error.log warn;
	pid        /var/run/nginx.pid;
	
	
	events {
	    worker_connections  1024;
	}
	
	
	http {  #全局配置部分，server{}如果不重写，则集成
	   include       /etc/nginx/mime.types;
	    default_type  application/octet-stream;
	
	    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
	                      '$status $body_bytes_sent "$http_referer" '
	                      '"$http_user_agent" "$http_x_forwarded_for"';   # 日志格式；
	
	    access_log  /var/log/nginx/access.log  main;   #默认的网站访问日志；
	
	    sendfile        on;
	    #tcp_nopush     on;
	
	    keepalive_timeout  65;  #跟客户端保持的长链接时长；
	
	    #gzip  on;
	
	    include /etc/nginx/conf.d/*.conf;  # 用来告知Nginx服务，要加载所有以conf结尾的文件，作为nginx.conf的一部分。主要用来配置多个虚拟主机。
	}
   ```

## Nginx如何处理一个request及配置虚拟主机

#### 目前来说有三种方式配置虚拟主机

> 1. 基于域名, 现代的做法.
> 2. 基于IP地址, 由于Ipv4资源不足和资金问题，基本上不咋用。
> 3. 基于端口，用于用户来说体验不好，基本上不咋用。

 
1. Nginx处理请求流程:
   1. nginx首先根据请求头部的host字段决定由哪一个虚拟主机处理对应的请求。
   2. 如果对应的host值没有匹配到合适的虚拟主机，nginx则路由这个请求到默认的主机。
   3. nginx根据对应虚拟主机配置文件中的定义，顺序匹配server块中break, if, return, rewrite, 和set语句。
   4. 然后匹配location(如果有多个location，则重复匹配)，匹配最长前缀location，然后再找正则表达式匹配，如果匹配到正则表达式，则匹配完成，直接处理请求，如果匹配不到正则表达式，那么按照最长前缀location匹配处理请求。如果有"=", 则为精确匹配，请求则匹配“=”，停止其它匹配，直接处理请求。
   5. 如果使用“=”， 那么意思就是精确匹配，如果请求匹配，匹配停止

   
2. 创建一个自定义的virtual host叫做lambert.com.

	```
	[root@srv-lambert-centos-test1 images]# cat /etc/nginx/conf.d/lambert.com.conf
	  server {
	          server_name     lambert.com www.lambert.com;     #虚拟主机名
	          root /var/www/sites/lambert.com;  #网站根目录
	          access_log   /var/log/nginx/lambert.com/access_lambert-check.log  main;  #定义网站的访问日志文件位置
	          error_log   /var/log/nginx/lambert.com/error_lambert-check.log;   #定义网站访问错误的日志文件位置
	
	          location / {
	            index index.html;
	          }
	
	          location = / {
	            index index.html;
	          }
	
	         location ^~ /images/ {
	            expires 1d;
	          }
	
	         location ~*  \.(jpg|jpeg|png|gif|ico|css|js)$ {
	            expires 365d;
	         }
	
	         location /documents/ {
	           index doc.html;
	         }
	
	
	         location ~ \.php$ {
	            fastcgi_pass   127.0.0.1:9000;
	            #fastcgi_pass   unix:/tmp/php-fpm.sock;
	            fastcgi_index  index.php;
	            #fastcgi_buffer_size 128k;
	            #fastcgi_buffers 64 256k;
	            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
	            include        fastcgi_params;
	
	         }
	
	  }
	```
  
3. 重启Nginx，加载虚拟主机。

	```
	[root@srv-lambert-centos-test1 conf.d]# /etc/init.d/nginx restart
	Stopping nginx:                                            [  OK  ]
	Starting nginx:                                            [  OK  ]
	```

## Nginx上配置重定向
###### 可以通过rewrite和return处理none-www到www的请求，或http到https的重定向请求。但是return的效率相对来说比较高，因为return通过内置变量直接返回，而rewrite需要匹配请求的url。

```
## Redirect from non-www to www
server {
    server_name lambert.com www.lambert.com;
    if ($host !~* ^www\.){
        #Option 1. - good
        #rewrite ^(.*)$ http://www.lambert.com$1  permanent;
        #Option 2. - better
        return 301 http://www.lambert.com$request_uri;
     }
}

## Redirect from http to https
server {
    server_name lambert.com www.lambert.com;
    if ($scheme = http) {
       #Option 1. - good
       rewrite ^(.*)$ https://www.lambert.com$1  permanent;
       #Option 2. - better
       #return  301 https://$http_host$request_uri;
    }
}
```

## AppGw 502问题的troubleshooting

#### 1. 先说说502.
----
> ###### 1. 什么是HTTP 502,标准的502定义是什么？
> > 作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应或后端服务不可用时。注意：HTTP的响应代码永远是对于客户端来说的。

> ##### 2. 当什么时候，AppGw会将后端标记为healthy状态？
> > 默认情况下，如果后端返回的http状态码是200˜399。那么则认为后端健康检查正常。如果是end-to-end SSL，AppGw还会那配置在对应的HTTPSetting中的证书和后端服务器返回的证书比较，如果一样，且证书有效，则认为成功。

> ##### 3. 为什么AppGw会返回502给客户端？
> > 1. 后端所有主机健康检查不通过，AppGw直接返回502。(95%)
> > 2. 如果后端只有一台主机，健康检查通过，但是客户端收到502。(2%)
> > 3. 如果后端有多台主机(>=2), 健康检查都通过，但是客户端有时会收到502，有时正常。(2%)

----

#### 2. 当AppGw后端为nginx服务器时，如何找到导致健康检查失败的原因？

   
   1. 首先检查AppGw的配置，弄清楚客户的逻辑流量走向。
   
   2. 通过Orb或Jarvis检查AppGw的后端检查状态。
   
   3. 如果后端是unhealthy，登陆客户的服务器，先做“**netstat -nlpt**”查看对应的port有没有在监听。如果有监听，查看监听的地址， 如果服务监听的地址在127.0.0.1,说明此nginx只能从localhost访问，engage客户将服务监听在0.0.0.0.

	```     
	[root@srv-lambert-centos-test1 conf.d]# netstat -nlpt
	Active Internet connections (only servers)
	Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name
	tcp        0      0 127.0.0.1:80                  0.0.0.0:*                   LISTEN      35571/nginx 
	tcp        0      0 127.0.0.1:443                  0.0.0.0:*                   LISTEN      35571/nginx 
	```
	
		  
   4.  如果后端是unhealthy，客户使用的是SSL Offload或者纯HTTP模式。
       1. 如果客户使用默认的probe，那么AppGw会通过http://127.0.0.1:<port>/进行后端健康检查，那么你可以登陆到客户的服务器, 执行**curl http://127.0.0.1:<port> -I**", 如果返回的http状态码是4xx或5xx。那你可以帮助客户修复问题或engage客户去做修复操作。
    
		```
		[root@srv-lambert-centos-test1 conf.d]# curl http://127.0.0.1:80 -I
		HTTP/1.1 404 OK
		Server: nginx/1.13.12
		Date: Mon, 28 May 2018 12:25:30 GMT
		Content-Type: text/html
		Content-Length: 612
		Last-Modified: Tue, 10 Apr 2018 14:25:21 GMT
		Connection: keep-alive
		ETag: "5accc951-264"
		Accept-Ranges: bytes
		```
			
			 
     2. 如果客户使用的是自定义的probe，比如probe定义的host为www.lambert.com或127.0.0.1, path为/health.html，则执行**curl http://127.0.0.1:<port>/health.html -I**"
        
      ```
	   [root@srv-lambert-centos-test1 conf.d]# curl http://127.0.0.1:80/health.html -I
		HTTP/1.1 200 OK
		Server: nginx/1.13.12
		Date: Mon, 28 May 2018 12:27:30 GMT
		Content-Type: text/html
		Content-Length: 612
		Last-Modified: Tue, 10 Apr 2018 14:25:21 GMT
		Connection: keep-alive
		ETag: "5accc951-264"
		Accept-Ranges: bytes
		```  
        
      > 这里请注意：我曾碰到客户在AppGw托管基于域名的站点，比如在Listener上配置www.lambert.com，在BackendPool配置的是www.lambert.com，然后客户将www.lambert.com的DNS解析在AppGw上。因此在处理这类问题时，建议先在客户的后端机器上做个nslookup，然后看看VNet上有无设置custom DNS。
  
	
 5 . 如果后端是unhealthy，并且使用的是end-to-end SSL。请再次查看对应的probe.
  
   1. 如果是默认的probe,AppGw则使用https://127.0.0.1:<port>/对后端进行探测。
     
     ```
     # 由于没有默认https站点，curl的时候连接失败
     [root@srv-lambert-centos-test1 conf.d]# curl https://127.0.0.1 -I
	  curl: (7) couldn't connect to host
     ```
     
  2. 如果客户使用的是自定义的probe，比如probe host为127.0.0.1, path为/health.html. 证书为www.lambert.com， 那么你可以登陆到客户的后端服务器上执行**curl https://127.0.0.1 -I/health.html**， 看是否有默认的站点响应.
  
      ```
	   [root@srv-lambert-centos-test1 conf.d]# curl https://127.0.0.1/health.html -I
		HTTP/1.1 200 OK
		Server: nginx/1.13.12
		Date: Mon, 28 May 2018 12:27:30 GMT
		Content-Type: text/html
		Content-Length: 612
		Last-Modified: Tue, 10 Apr 2018 14:28:21 GMT
		Connection: keep-alive
		ETag: "5accc951-264"
		Accept-Ranges: bytes
		```  
  3 . 如果站点响应正常。验证服务器的证书(是否过期)，然后跟AppGw的证书比对。
  
       ```
      [root@srv-lambert-centos-test1 ssl]# netstat -nlpt | grep 80
		tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      35571/nginx
		[root@srv-lambert-centos-test1 ssl]# ps aux | grep 35571
		root      35571  0.0  0.1  47456  1228 ?        Ss   20:49   0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
		root      36864  0.0  0.0 103296   792 pts/0    S+   21:34   0:00 grep 35571
		[root@srv-lambert-centos-test1 ssl]# cat /etc/nginx/nginx.conf
		[root@srv-lambert-centos-test1 ssl]# cat /etc/nginx/conf.d/lambert.com.conf
		[root@srv-lambert-centos-test1 ssl]# openssl x509 -in /etc/nginx/ssl/lambert.com.crt -text -noout
		Certificate:
		    Data:
		        Version: 1 (0x0)
		        Serial Number: 9694034267415001718 (0x868820ce15bc3a76)
		    Signature Algorithm: sha1WithRSAEncryption
		        Issuer: C=CN, ST=SH, L=ShangHai, O=Lambert, OU=Lz, CN=*.lambert.com/emailAddress=lz@lz.com   //证书为一级证书 *.lambert.com
		        Validity
		            Not Before: May 30 12:41:21 2018 GMT
		            Not After : May 30 12:41:21 2019 GMT   //证书过期时间
		        Subject: C=CN, ST=SH, L=ShangHai, O=Lambert, OU=Lz, CN=*.lambert.com/emailAddress=lz@lz.com
		        Subject Public Key Info:
		            Public Key Algorithm: rsaEncryption
		                Public-Key: (1024 bit)
		                Modulus:
		                    00:ed:4d:8c:74:67:82:ec:d6:96:88:36:ba:50:69:
		                    1c:f4:74:d3:4f:e9:58:bf:f5:a2:21:5a:24:7e:c4:
		                    b3:8c:d2:de:07:b5:47:73:c0:24:08:d9:b3:f9:90:
		                    1d:b8:ce:ef:5f:f4:ad:3e:d4:1a:cc:cc:31:d1:5f:
		                    6b:7b:86:6c:39:67:88:61:73:29:20:4e:00:cd:be:
		                    5c:df:01:ab:f7:e2:69:be:5a:0e:77:2f:33:28:40:
		                    3b:b0:a1:7a:5f:0a:33:7d:e4:54:54:68:32:e1:9b:
		                    07:80:98:8b:d2:cc:54:c8:a8:67:b5:71:31:f1:53:
		                    4a:41:e0:43:f8:5d:9b:6e:f3
		                Exponent: 65537 (0x10001)
		    Signature Algorithm: sha1WithRSAEncryption
		         12:09:e2:06:93:a4:a7:ff:c7:20:83:1a:3c:a2:c9:ef:cb:80:
		         37:62:1d:f6:03:41:de:89:a8:62:9a:42:88:41:79:ce:79:ce:
		         ec:81:98:72:25:09:ba:2d:65:ae:1b:56:ce:41:2b:e5:23:5d:
		         0a:f8:5f:44:88:b4:fb:20:88:08:74:1a:f2:f0:e6:01:40:65:
		         e2:1c:9d:19:4e:1e:e2:cf:1a:82:1b:91:0c:51:38:e8:22:04:
		         f1:90:74:18:32:15:7f:86:78:9d:57:43:0a:1c:28:0a:4b:f2:
		         f6:59:87:92:03:91:60:30:2a:a2:68:e7:e1:d8:bd:6a:be:50:
		         f5:64
		[root@srv-lambert-centos-test1 ssl]# openssl s_client -connect 127.0.0.1:443 -servername www.lambert.com
		CONNECTED(00000003)
		depth=0 C = CN, ST = SH, L = ShangHai, O = Lambert, OU = Lz, CN = *.lambert.com, emailAddress = lz@lz.com
		verify error:num=18:self signed certificate
		verify return:1
		depth=0 C = CN, ST = SH, L = ShangHai, O = Lambert, OU = Lz, CN = *.lambert.com, emailAddress = lz@lz.com
		verify return:1
		---
		Certificate chain
		 0 s:/C=CN/ST=SH/L=ShangHai/O=Lambert/OU=Lz/CN=*.lambert.com/emailAddress=lz@lz.com
		   i:/C=CN/ST=SH/L=ShangHai/O=Lambert/OU=Lz/CN=*.lambert.com/emailAddress=lz@lz.com
		---
		Server certificate
		-----BEGIN CERTIFICATE-----
		MIICczCCAdwCCQCGiCDOFbw6djANBgkqhkiG9w0BAQUFADB+MQswCQYDVQQGEwJD
		TjELMAkGA1UECAwCU0gxETAPBgNVBAcMCFNoYW5nSGFpMRAwDgYDVQQKDAdMYW1i
		ZXJ0MQswCQYDVQQLDAJMejEWMBQGA1UEAwwNKi5sYW1iZXJ0LmNvbTEYMBYGCSqG
		SIb3DQEJARYJbHpAbHouY29tMB4XDTE4MDUzMDEyNDEyMVoXDTE5MDUzMDEyNDEy
		MVowfjELMAkGA1UEBhMCQ04xCzAJBgNVBAgMAlNIMREwDwYDVQQHDAhTaGFuZ0hh
		aTEQMA4GA1UECgwHTGFtYmVydDELMAkGA1UECwwCTHoxFjAUBgNVBAMMDSoubGFt
		YmVydC5jb20xGDAWBgkqhkiG9w0BCQEWCWx6QGx6LmNvbTCBnzANBgkqhkiG9w0B
		AQEFAAOBjQAwgYkCgYEA7U2MdGeC7NaWiDa6UGkc9HTTT+lYv/WiIVokfsSzjNLe
		B7VHc8AkCNmz+ZAduM7vX/StPtQazMwx0V9re4ZsOWeIYXMpIE4Azb5c3wGr9+Jp
		vloOdy8zKEA7sKF6XwozfeRUVGgy4ZsHgJiL0sxUyKhntXEx8VNKQeBD+F2bbvMC
		AwEAATANBgkqhkiG9w0BAQUFAAOBgQASCeIGk6Sn/8cggxo8osnvy4A3Yh32A0He
		iahimkKIQXnOec7sgZhyJQm6LWWuG1bOQSvlI10K+F9EiLT7IIgIdBry8OYBQGXi
		HJ0ZTh7izxqCG5EMUTjoIgTxkHQYMhV/hnidV0MKHCgKS/L2WYeSA5FgMCqiaOfh
		2L1qvlD1ZA==
		-----END CERTIFICATE-----
		subject=/C=CN/ST=SH/L=ShangHai/O=Lambert/OU=Lz/CN=*.lambert.com/emailAddress=lz@lz.com
		issuer=/C=CN/ST=SH/L=ShangHai/O=Lambert/OU=Lz/CN=*.lambert.com/emailAddress=lz@lz.com
		---
		No client certificate CA names sent
		Server Temp Key: ECDH, prime256v1, 256 bits
		---
		SSL handshake has read 1200 bytes and written 405 bytes
		---
		New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES256-SHA
		Server public key is 1024 bit
		Secure Renegotiation IS supported
		Compression: NONE
		Expansion: NONE
		SSL-Session:
		    Protocol  : TLSv1
		    Cipher    : ECDHE-RSA-AES256-SHA
		    Session-ID: F024BD97D233B78F6B615722F99CC84D9935A257ECA7DD2AD7FA6EEE91373DA6
		    Session-ID-ctx:
		    Master-Key: 8140321D4150F992F2A3F86EF0EC466FBCAFC5CAF016B741422E4BC19AFC21B7A0FE3875F54A972D826B3325DCA92F33
		    Key-Arg   : None
		    Krb5 Principal: None
		    PSK identity: None
		    PSK identity hint: None
		    TLS session ticket lifetime hint: 300 (seconds)
		    TLS session ticket:
		    0000 - 1f f9 26 75 79 87 2d 86-06 a1 ed 0a c9 f9 02 ad   ..&uy.-.........
		    0010 - bf 1b 93 f4 a6 78 59 6a-4c 93 ca f7 1d f9 71 98   .....xYjL.....q.
		    0020 - 54 9f f2 1e d9 f8 68 ef-8d 0b 98 ca df fa cf 7b   T.....h........{
		    0030 - 6f 65 e1 28 31 84 05 94-d8 3e a2 d9 10 d7 42 3d   oe.(1....>....B=
		    0040 - 22 cb 58 77 4b a6 79 b3-cf d3 42 c6 57 03 04 80   ".XwK.y...B.W...
		    0050 - 34 b1 01 98 4f e0 fe fb-10 e4 14 1e 8f 5c de 23   4...O........\.#
		    0060 - 06 bd ea 11 d1 50 de dc-2d 77 84 f8 d5 e1 13 f7   .....P..-w......
		    0070 - 04 b8 bb 81 15 4e 9e 03-53 04 20 42 1b 6a 01 50   .....N..S. B.j.P
		    0080 - aa 13 01 fa d7 fa 30 e1-df 73 e9 e4 ee 23 6c ec   ......0..s...#l.
		    0090 - 00 58 8d 88 22 d4 b9 ad-08 3c c9 6c 62 52 a4 9c   .X.."....<.lbR..
		    00a0 - 60 6c 9f d9 6f b8 1d 2e-e9 cb dd dd 6d ce d2 a9   `l..o.......m...
		    00b0 - fe 32 6c dc 91 f9 49 89-15 8e 43 fa 92 f3 6a 84   .2l...I...C...j.
		
		    Start Time: 1527687553
		    Timeout   : 300 (sec)
		    Verify return code: 18 (self signed certificate)
		---
      ```

### 特殊问题：
> 如果客户的后端没有默认的站点，但是客户的域名解析到AppGw上，那么如何配置AppGw的backendPool和Probe呢？

```
# Azure portal配置AppGw的backendpool为后端服务器的内网地址. 通过PowerShell或Restful API修改AppGw请求的http头部，添加Host
$AppGw = Get-AzureRmApplicationGateway -Name "ApplicationGateway01" -ResourceGroupName "ResourceGroup01"
Add-AzureRmApplicationGatewayBackendHttpSettings -ApplicationGateway $AppGw -Name "Setting02" -Port 80 -HostName "www.lambert.com" -Protocol "HTTP" -CookieBasedAffinity "Disabled"
Add-AzureRmApplicationGatewayProbeConfig -ApplicationGateway Gateway -Name "Probe01" -Protocol Http -HostName "contoso.com" -Path "/health.html" -Interval 30 -Timeout 120 -UnhealthyThreshold 8 -PickHostNameFromBackendHttpSettings
```

